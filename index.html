<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Profit Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ... [styles as in your original file, unchanged] ... */
    /* You do not need to change any styles! */
    /* CSS omitted for brevity */
  </style>
</head>
<body>
  <div class="container">
    <header>
      <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
        <span class="theme-icon" id="themeIcon">üåô</span>
        <span id="themeLabel">Dark</span>
      </button>
      <h1>Profit Calculator</h1>
      <p class="subtitle">
        Calculate optimal pricing across multiple resale platforms. See required prices and net profits with platform-specific fees instantly.
      </p>
    </header>

    <div class="main-grid">
      <div class="card">
        <h2 class="card-title">Input Parameters</h2>
        <div class="input-grid">
          <div class="input-group">
            <label for="cogs">Cost of Goods</label>
            <input id="cogs" type="number" step="0.01" value="1.25" />
          </div>
          <div class="input-group">
            <label for="material">Material Cost</label>
            <input id="material" type="number" step="0.01" value="0.95" />
          </div>
          <div class="input-group">
            <label for="ship">Shipping Cost (seller)</label>
            <input id="ship" type="number" step="0.01" value="6.00" />
          </div>
          <div class="input-group">
            <label for="target">Target Profit</label>
            <input id="target" type="number" step="0.01" value="5.00" />
          </div>
          <div class="input-group">
            <label for="markup">Markup Percentage (%)</label>
            <input id="markup" type="number" step="1" value="50" min="0" />
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="card-title">Pricing Results</h2>
        <table id="results">
          <thead>
            <tr>
              <th>Platform</th>
              <th>Required Price</th>
              <th>List (Markup)</th>
              <th>Fees @ List</th>
              <th>Net Profit @ List</th>
              <th class="muted">Assumptions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="table-note">
          <span class="badge">.99 rounding</span> Etsy, eBay ‚Ä¢ 
          <span class="badge">Whole dollars</span> Depop, Poshmark, Mercari ‚Ä¢ 
          Poshmark uses under $15 flat $2.95 vs 20% at $15+.
        </div>
      </div>
    </div>

    <div class="card fee-table-card">
      <h2 class="card-title">Platform Fee Table</h2>
      <p class="small muted" style="margin-bottom: 16px;">‚úèÔ∏è Click any cell to edit ‚Ä¢ Changes update results instantly</p>
      <table>
        <thead>
          <tr>
            <th>Platform</th>
            <th>Fee %</th>
            <th>Promo %</th>
            <th>Flat Fee $</th>
            <th>Seller Pays Ship?</th>
            <th>Default Rounding</th>
          </tr>
        </thead>
        <tbody id="feeRows"></tbody>
      </table>
    </div>
  </div>

  <script>
    let currentTheme = 'dark';

    function initTheme() {
      setTheme(currentTheme);
    }

    function setTheme(theme) {
      currentTheme = theme;
      document.body.setAttribute('data-theme', theme);
      const icon = document.getElementById('themeIcon');
      const label = document.getElementById('themeLabel');
      
      if (theme === 'light') {
        icon.textContent = '‚òÄÔ∏è';
        label.textContent = 'Light';
      } else {
        icon.textContent = 'üåô';
        label.textContent = 'Dark';
      }
    }

    function toggleTheme() {
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    }

    initTheme();
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);

    const PLATFORMS = [
      { name: 'Etsy',     feePct: 0.095, promoPct: 0.00, flatFee: 0.45, sellerPaysShip: true,  rounding: '.99' },
      { name: 'eBay',     feePct: 0.136, promoPct: 0.12, flatFee: 0.30, sellerPaysShip: true,  rounding: '.99' },
      { name: 'Depop',    feePct: 0.033, promoPct: 0.08, flatFee: 0.45, sellerPaysShip: false, rounding: 'whole' },
      { name: 'Poshmark', feePct: 0.20,  promoPct: 0.00, flatFee: 2.95, sellerPaysShip: false, rounding: 'whole' },
      { name: 'Mercari',  feePct: 0.10,  promoPct: 0.00, flatFee: 0.00, sellerPaysShip: false, rounding: 'whole' },
    ];

    const ceilDot99 = (x) => Math.max(0.99, Math.ceil(x) - 0.01);
    const ceilWhole  = (x) => Math.ceil(x);
    const money = (n) => '$' + Number(n).toFixed(2);

    function getRoundingFor(platformName) {
      const def = PLATFORMS.find(p => p.name === platformName)?.rounding || 'whole';
      return def === '.99' ? ceilDot99 : ceilWhole;
    }

    function requiredPriceGeneric(costBaseNoFee, feePct, promoPct, flatFee) {
      const rate = feePct + promoPct;
      const denom = 1 - rate;
      return (costBaseNoFee + flatFee) / Math.max(1e-9, denom);
    }

    function requiredPricePosh(costBaseNoFee, roundingFn) {
      const rawA = costBaseNoFee + 2.95;
      const rA = roundingFn(rawA);
      const validA = rA < 15;

      const rawB = costBaseNoFee / (1 - 0.20);
      const rB = roundingFn(rawB);
      const validB = rB >= 15;

      if (validA && validB) {
        return Math.min(rA, rB);
      } else if (validA) {
        return rA;
      } else if (validB) {
        return rB;
      } else {
        return 15;
      }
    }

    function feesAtList(platform, listPrice) {
      if (platform.name === 'Poshmark') {
        if (listPrice < 15) return 2.95;
        return listPrice * 0.20;
      }
      return listPrice * (platform.feePct + platform.promoPct) + platform.flatFee;
    }

    function compute() {
      const cogs     = parseFloat(document.getElementById('cogs').value) || 0;
      const material = parseFloat(document.getElementById('material').value) || 0;
      const ship     = parseFloat(document.getElementById('ship').value) || 0;
      const target   = parseFloat(document.getElementById('target').value) || 0;
      const markupPct = parseFloat(document.getElementById('markup').value) || 0;
      const markup   = 1 + (markupPct / 100);

      const tbody = document.querySelector('#results tbody');
      tbody.classList.add('updating');

      setTimeout(() => {
        tbody.innerHTML = '';

        PLATFORMS.forEach((p, index) => {
          const roundingFn = getRoundingFor(p.name);
          const costBaseNoFee = target + cogs + material + (p.sellerPaysShip ? ship : 0);

          let requiredRounded;
          if (p.name === 'Poshmark') {
            requiredRounded = requiredPricePosh(costBaseNoFee, roundingFn);
          } else {
            const requiredRaw = requiredPriceGeneric(costBaseNoFee, p.feePct, p.promoPct, p.flatFee);
            requiredRounded = roundingFn(requiredRaw);
          }

          const listRounded = roundingFn(requiredRounded * markup);
          const feeAtList = feesAtList(p, listRounded);
          const shipCostAtList = p.sellerPaysShip ? ship : 0;
          const netAtList = listRounded - feeAtList - shipCostAtList - cogs - material;

          const tr = document.createElement('tr');
          tr.style.animationDelay = `${index * 0.05}s`;
          tr.innerHTML = `
            <td><span class="platform-name">${p.name}</span></td>
            <td class="mono">${money(requiredRounded)}</td>
            <td class="mono">${money(listRounded)}</td>
            <td class="mono">${money(feeAtList)}</td>
            <td class="mono ${netAtList >= target ? 'ok' : 'warn'}">${money(netAtList)}</td>
            <td class="muted small">${(p.sellerPaysShip ? 'Seller pays ship' : 'Buyer pays ship')} ‚Ä¢ ${p.rounding === '.99' ? '.99' : 'Whole'}</td>
          `;
          tbody.appendChild(tr);
        });

        tbody.classList.remove('updating');
      }, 100);
    }

    function renderFees() {
      const feeBody = document.getElementById('feeRows');
      feeBody.innerHTML = '';
      PLATFORMS.forEach((p, index) => {
        const tr = document.createElement('tr');
        
        const tdName = document.createElement('td');
        tdName.innerHTML = `<span class="platform-name">${p.name}</span>`;
        tr.appendChild(tdName);
        
        const tdFee = document.createElement('td');
        tdFee.innerHTML = `
          <div class="cell-with-arrows">
            <span class="cell-value" contenteditable="true" data-platform="${index}" data-field="feePct">${(p.feePct * 100).toFixed(1)}</span>
            <div class="arrow-buttons">
              <button class="arrow-btn" data-platform="${index}" data-field="feePct" data-direction="up">‚ñ≤</button>
              <button class="arrow-btn" data-platform="${index}" data-field="feePct" data-direction="down">‚ñº</button>
            </div>
          </div>
        `;
        tr.appendChild(tdFee);
        
        const tdPromo = document.createElement('td');
        tdPromo.innerHTML = `
          <div class="cell-with-arrows">
            <span class="cell-value" contenteditable="true" data-platform="${index}" data-field="promoPct">${(p.promoPct * 100).toFixed(1)}</span>
            <div class="arrow-buttons">
              <button class="arrow-btn" data-platform="${index}" data-field="promoPct" data-direction="up">‚ñ≤</button>
              <button class="arrow-btn" data-platform="${index}" data-field="promoPct" data-direction="down">‚ñº</button>
            </div>
          </div>
        `;
        tr.appendChild(tdPromo);
        
        const tdFlat = document.createElement('td');
        tdFlat.innerHTML = `
          <div class="cell-with-arrows">
            <span class="cell-value" contenteditable="true" data-platform="${index}" data-field="flatFee">${p.flatFee.toFixed(2)}</span>
            <div class="arrow-buttons">
              <button class="arrow-btn" data-platform="${index}" data-field="flatFee" data-direction="up">‚ñ≤</button>
              <button class="arrow-btn" data-platform="${index}" data-field="flatFee" data-direction="down">‚ñº</button>
            </div>
          </div>
        `;
        tr.appendChild(tdFlat);
        
        const tdShip = document.createElement('td');
        tdShip.innerHTML = `
          <select class="fee-select" data-platform="${index}" data-field="sellerPaysShip">
            <option value="yes" ${p.sellerPaysShip ? 'selected' : ''}>Yes</option>
            <option value="no" ${!p.sellerPaysShip ? 'selected' : ''}>No</option>
          </select>
        `;
        tr.appendChild(tdShip);
        
        const tdRounding = document.createElement('td');
        tdRounding.innerHTML = `
          <select class="fee-select" data-platform="${index}" data-field="rounding">
            <option value=".99" ${p.rounding === '.99' ? 'selected' : ''}>.99</option>
            <option value="whole" ${p.rounding === 'whole' ? 'selected' : ''}>Whole</option>
          </select>
        `;
        tr.appendChild(tdRounding);
        
        feeBody.appendChild(tr);
      });
      attachEditListeners();
    }

    function attachEditListeners() {
      const editableCells = document.querySelectorAll('.cell-value');
      editableCells.forEach(cell => {
        cell.addEventListener('blur', handleCellEdit);
        cell.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            cell.blur();
          }
        });
      });
      
      const arrowButtons = document.querySelectorAll('.arrow-btn');
      arrowButtons.forEach(btn => {
        btn.addEventListener('click', handleArrowClick);
      });
      
      const selects = document.querySelectorAll('.fee-select');
      selects.forEach(select => {
        select.addEventListener('change', handleSelectChange);
      });
    }

    function handleCellEdit(e) {
      const cell = e.target;
      const platformIdx = parseInt(cell.dataset.platform);
      const field = cell.dataset.field;
      const value = cell.textContent.trim();
      
      const platform = PLATFORMS[platformIdx];
      
      try {
        if (field === 'feePct' || field === 'promoPct') {
          const numVal = parseFloat(value);
          if (isNaN(numVal) || numVal < 0 || numVal > 100) {
            throw new Error('Invalid percentage');
          }
          platform[field] = numVal / 100;
          cell.textContent = numVal.toFixed(1);
        } else if (field === 'flatFee') {
          const numVal = parseFloat(value);
          if (isNaN(numVal) || numVal < 0) {
            throw new Error('Invalid fee');
          }
          platform[field] = numVal;
          cell.textContent = numVal.toFixed(2);
        }
        
        compute();
      } catch (err) {
        renderFees();
      }
    }
    
    function handleArrowClick(e) {
      e.preventDefault();
      const btn = e.currentTarget;
      const platformIdx = parseInt(btn.dataset.platform);
      const field = btn.dataset.field;
      const direction = btn.dataset.direction;
      
      const platform = PLATFORMS[platformIdx];
      
      if (field === 'feePct' || field === 'promoPct') {
        const increment = 0.005;
        const currentVal = platform[field];
        let newVal = direction === 'up' ? currentVal + increment : currentVal - increment;
        newVal = Math.max(0, Math.min(1, newVal));
        platform[field] = newVal;
      } else if (field === 'flatFee') {
        const increment = 0.05;
        const currentVal = platform[field];
        let newVal = direction === 'up' ? currentVal + increment : currentVal - increment;
        newVal = Math.max(0, newVal);
        platform[field] = newVal;
      }
      
      renderFees();
      compute();
    }
    
    function handleSelectChange(e) {
      const select = e.target;
      const platformIdx = parseInt(select.dataset.platform);
      const field = select.dataset.field;
      const value = select.value;
      
      const platform = PLATFORMS[platformIdx];
      
      if (field === 'sellerPaysShip') {
        platform[field] = value === 'yes';
      } else if (field === 'rounding') {
        platform[field] = value;
      }
      
      compute();
    }

    let debounceTimer;
    function debounceCompute() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(compute, 150);
    }

    const inputs = ['cogs', 'material', 'ship', 'target', 'markup'];
    inputs.forEach(id => {
      const element = document.getElementById(id);
      element.addEventListener('input', debounceCompute);
    });

    renderFees();
    compute();
  </script>
</body>
</html>
